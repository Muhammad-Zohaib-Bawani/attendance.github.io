<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Tracker Pro | MicroSysX Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet" />
  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #00d2ff;
      --secondary: #3a7bd5;
      --accent: #f093fb;
      --background: #0b0f19;
      --surface: #161c2d;
      --surface-light: #1e293b;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --glass: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.1);
      --success: #10b981;
      --danger: #f43f5e;
      --warning: #f59e0b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
    }

    body {
      font-family: "Inter", sans-serif;
      background: var(--background);
      background-image: radial-gradient(circle at 10% 20%,
          rgba(58, 123, 213, 0.1) 0%,
          transparent 40%),
        radial-gradient(circle at 90% 80%,
          rgba(0, 210, 255, 0.1) 0%,
          transparent 40%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    header {
      padding: 4rem 2rem 2rem;
      text-align: center;
    }

    header h1 {
      font-family: "Outfit", sans-serif;
      font-size: 3.5rem;
      font-weight: 800;
      background: linear-gradient(to right,
          var(--primary),
          var(--secondary),
          var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
      letter-spacing: -2px;
    }

    header p {
      color: var(--text-muted);
      font-size: 1.1rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-weight: 500;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      width: 95%;
      padding-bottom: 5rem;
    }

    .main-card {
      background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: 2rem;
      padding: 3rem;
      box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    .main-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    @media (max-width: 850px) {
      .config-grid {
        grid-template-columns: 1fr;
      }
    }

    .input-box {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .input-box label {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-left: 0.25rem;
    }

    input,
    select {
      background: var(--surface-light);
      border: 1px solid var(--glass-border);
      border-radius: 1rem;
      padding: 0.9rem 1.25rem;
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0, 210, 255, 0.1);
      transform: translateY(-1px);
    }

    .file-drop {
      position: relative;
      border: 2px dashed var(--glass-border);
      border-radius: 1rem;
      padding: 0.8rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--glass);
    }

    .file-drop:hover {
      border-color: var(--primary);
      background: rgba(0, 210, 255, 0.05);
    }

    .file-drop input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .file-drop-text {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .file-drop-text span {
      color: var(--primary);
    }

    .btn-export {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 0.9rem 1.5rem;
      border-radius: 1rem;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-family: 'Outfit', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
      margin-top: auto;
      height: 52px;
    }

    .btn-export:hover {
      opacity: 0.95;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.3);
    }

    .stats-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stat-item {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 1.5rem;
      padding: 2rem 1.5rem;
      text-align: center;
      transition: transform 0.3s ease;
    }

    .stat-item:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.05);
    }

    .stat-val {
      font-family: "Outfit", sans-serif;
      font-size: 2.25rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.5rem;
      display: block;
    }

    .stat-lbl {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 2.5px;
      color: var(--text-muted);
      font-weight: 700;
    }

    .data-section {
      background: var(--surface-light);
      border-radius: 2rem;
      border: 1px solid var(--glass-border);
      overflow: hidden;
      min-height: 300px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: rgba(255, 255, 255, 0.03);
      padding: 1.5rem;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--glass-border);
    }

    td {
      padding: 1.5rem;
      border-bottom: 1px solid var(--glass-border);
      font-size: 1rem;
      font-weight: 500;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.015);
    }

    .editable-time {
      background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: 2rem;
      padding: 0.5rem 1rem;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 700;
      text-align: center;
      width: 120px;
      outline: none;
      transition: all 0.2s;
    }

    .editable-time:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 210, 255, 0.2);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.85rem;
      font-weight: 800;
    }

    .tag-duration {
      background: rgba(0, 210, 255, 0.1);
      color: var(--primary);
    }

    .msg-cell {
      font-size: 0.8rem;
      color: var(--text-muted);
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: help;
    }

    .empty-visual {
      padding: 6rem 2rem;
      text-align: center;
      color: var(--text-muted);
    }

    .empty-visual svg {
      width: 64px;
      height: 64px;
      margin-bottom: 1.5rem;
      opacity: 0.1;
    }

    footer {
      padding: 4rem 2rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      opacity: 0.5;
      margin-top: auto;
    }

    .animate-up {
      animation: slideUp 0.8s cubic-bezier(0.2, 1, 0.3, 1) forwards;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <header>
    <p>MicroSysX Advanced Analytics</p>
    <h1>Attendance Tracker</h1>
  </header>

  <div class="container animate-up">
    <div class="main-card">
      <div class="config-grid">
        <div class="input-box">
          <label>WhatsApp Log (.txt)</label>
          <div class="file-drop">
            <input type="file" id="fileInput" accept=".txt" />
            <div class="file-drop-text" id="fileName">
              <span>Upload</span> or Drag file
            </div>
          </div>
        </div>
        <div class="input-box">
          <label>Full Identity</label>
          <input type="text" id="nameFilter" value="Zaib bawani" placeholder="Name in chat..." />
        </div>
        <div class="input-box">
          <label>Analysis Month</label>
          <select id="monthFilter">
            <option value="all">Full History</option>
            <script>
              const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
              months.forEach((m, i) => document.write(`<option value="${i}">${m}</option>`));
            </script>
          </select>
        </div>
        <div class="input-box">
          <label>Working Days</label>
          <input type="number" id="totalDays" value="21" min="1" />
        </div>
        <div class="input-box">
          <label>Daily Target (Hrs)</label>
          <input type="number" id="dailyHours" value="9" min="1" />
        </div>
        <button class="btn-export" id="exportBtn" style="display: none;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Export to Excel
        </button>
      </div>

      <div id="statsStrip" class="stats-strip" style="display: none;">
        <div class="stat-item">
          <span class="stat-lbl">Required Hours</span>
          <span class="stat-val" id="statRequired">0h</span>
        </div>
        <div class="stat-item">
          <span class="stat-lbl">Worked Hours</span>
          <span class="stat-val" id="statWorked">0h</span>
        </div>
        <div class="stat-item">
          <span class="stat-lbl">Avg Daily</span>
          <span class="stat-val" id="statAvg">0h</span>
        </div>
        <div class="stat-item">
          <span class="stat-lbl">Overtime</span>
          <span class="stat-val" id="statOvertime" style="color: var(--success);">0h</span>
        </div>
      </div>

      <div id="dataSection" class="data-section">
        <div class="empty-visual">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          <p>Upload your exported WhatsApp chat (.txt) to generate the intelligence report.</p>
        </div>
      </div>
    </div>
  </div>

  <footer>MicroSysX Intelligence Ledger &bull; Secure Local Processing</footer>

  <script>
    const fileInput = document.getElementById("fileInput");
    const nameFilterInput = document.getElementById("nameFilter");
    const monthFilterSelect = document.getElementById("monthFilter");
    const totalDaysInput = document.getElementById("totalDays");
    const dailyHoursInput = document.getElementById("dailyHours");
    const dataSection = document.getElementById("dataSection");
    const statsStrip = document.getElementById("statsStrip");
    const exportBtn = document.getElementById("exportBtn");
    const fileNameDisplay = document.getElementById("fileName");

    // Auto-set current month
    monthFilterSelect.value = new Date().getMonth().toString();

    let chatLines = [];
    let attendanceMap = {}; // date -> { sessions: [{in, out, inMsg, outMsg}], lastState }

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      fileNameDisplay.innerHTML = `Loaded: <span>${file.name}</span>`;
      const reader = new FileReader();
      reader.onload = (event) => {
        parseRawChat(event.target.result);
        processAndRender();
      };
      reader.readAsText(file);
    });

    [nameFilterInput, monthFilterSelect, totalDaysInput, dailyHoursInput].forEach(el => {
      el.addEventListener("input", processAndRender);
    });

    function parseRawChat(text) {
      const lines = text.split("\n");
      const messages = [];
      let currentMsg = null;
      // Supports [DD/MM/YY, HH:MM:SS AM/PM] or MM/DD/YY, HH:MM AM/PM
      const timestampRegex = /^(\[?\d{1,2}\/\d{1,2}\/\d{2,4}, \d{1,2}:\d{2}(?::\d{2})?\s*[AP]M\]?)\s*(- )?/;

      lines.forEach(line => {
        const match = line.match(timestampRegex);
        if (match) {
          if (currentMsg) messages.push(currentMsg);
          const rawTs = match[1].replace(/[\[\]]/g, '');
          const contentPart = line.substring(match[0].length).trim();
          const colonIndex = contentPart.indexOf(':');

          if (colonIndex !== -1) {
            const sender = contentPart.substring(0, colonIndex).trim();
            const content = contentPart.substring(colonIndex + 1).trim();
            messages.push({
              date: rawTs.split(', ')[0],
              time: rawTs.split(', ')[1],
              sender,
              content
            });
            currentMsg = messages[messages.length - 1];
          } else { currentMsg = null; }
        } else if (currentMsg) {
          currentMsg.content += " " + line.trim();
        }
      });
      chatLines = messages;
    }

    function processAndRender() {
      if (!chatLines.length) return;
      const target = nameFilterInput.value.trim().toLowerCase();
      const targetMonth = monthFilterSelect.value;
      const map = {};

      const inKW = /check(ed)?\s*in|signing\s*in|sign\s*in|âœ…|ðŸŸ¢/i;
      const outKW = /check(ed)?\s*out|signing\s*out|sign\s*out|ðŸ”´|checkout/i;

      chatLines.filter(m => m.sender.toLowerCase() === target).forEach(msg => {
        if (!map[msg.date]) map[msg.date] = { sessions: [], lastState: 'OUT' };
        const content = msg.content.toLowerCase();
        let action = null;

        if (outKW.test(content)) action = 'OUT';
        else if (inKW.test(content)) action = 'IN';
        else if (content.trim() === 'in') action = 'IN';
        else if (content.trim() === 'out') action = 'OUT';
        else {
          // SMART FLIP
          action = map[msg.date].lastState === 'IN' ? 'OUT' : 'IN';
        }

        if (action) {
          // Extract time from message if present (e.g., "Out at 8:30 PM")
          let useTime = msg.time;
          const timeRegex = /(\d{1,2}:\d{2}(?::\d{2})?\s*[AP]M)/i;
          const timeMatch = msg.content.match(timeRegex);
          if (timeMatch) useTime = timeMatch[1];

          if (action === 'IN') {
            map[msg.date].sessions.push({ inTime: useTime, inMsg: msg.content, outTime: null, outMsg: null });
            map[msg.date].lastState = 'IN';
          } else if (action === 'OUT') {
            const current = map[msg.date].sessions[map[msg.date].sessions.length - 1];
            if (current && !current.outTime) {
              current.outTime = useTime;
              current.outMsg = msg.content;
            } else {
              map[msg.date].sessions.push({ inTime: null, inMsg: null, outTime: useTime, outMsg: msg.content });
            }
            map[msg.date].lastState = 'OUT';
          }
        }
      });

      attendanceMap = map;
      renderUI();
    }

    function renderUI() {
      const sortedDates = Object.keys(attendanceMap).sort((a, b) => parseDate(a) - parseDate(b));
      const filteredDates = monthFilterSelect.value === 'all'
        ? sortedDates
        : sortedDates.filter(d => (parseInt(d.split('/')[0]) - 1) === parseInt(monthFilterSelect.value));

      if (!filteredDates.length) {
        dataSection.innerHTML = '<div class="empty-visual"><p>No activity matches current filters.</p></div>';
        statsStrip.style.display = 'none';
        exportBtn.style.display = 'none';
        return;
      }

      let html = `<table><thead><tr><th>Date & Weekday</th><th>Entry Time</th><th>Exit Time</th><th>Duration</th><th>Context</th></tr></thead><tbody>`;
      let totalMins = 0, totalDaysWorked = 0;

      filteredDates.forEach(date => {
        const sessions = attendanceMap[date].sessions;
        const dateObj = parseDate(date);
        const dayTitle = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });

        sessions.forEach((s, idx) => {
          const entry = s.inTime || '-';
          const exit = s.outTime || '-';
          const m = (s.inTime && s.outTime) ? calcMin(s.inTime, s.outTime) : 0;
          totalMins += m;
          if (idx === 0) totalDaysWorked++; // Count unique days

          const durText = m > 0 ? `${Math.floor(m / 60)}h ${m % 60}m` : '-';

          html += `<tr>
              <td style="font-weight:700; color:var(--text-muted)">${idx === 0 ? dayTitle : ''}</td>
              <td><input class="editable-time" value="${entry}" oninput="manualUpdateTime('${date}', ${idx}, 'in', this.value)"></td>
              <td><input class="editable-time" value="${exit}" oninput="manualUpdateTime('${date}', ${idx}, 'out', this.value)"></td>
              <td><span class="tag tag-duration">${durText}</span></td>
              <td class="msg-cell" title="IN: ${s.inMsg || '-'}\nOUT: ${s.outMsg || '-'}">Entry: ${s.inMsg || '-'}</td>
            </tr>`;
        });
      });

      html += '</tbody></table>';
      dataSection.innerHTML = html;
      statsStrip.style.display = 'grid';
      exportBtn.style.display = 'inline-flex';

      updateStats(totalDaysWorked, totalMins);
    }

    function manualUpdateTime(date, idx, type, val) {
      const session = attendanceMap[date].sessions[idx];
      if (type === 'in') session.inTime = val;
      else session.outTime = val;

      // Re-calculate local duration and stats without full re-parse
      let totalMins = 0, totalDaysWorked = 0;
      Object.keys(attendanceMap).forEach(d => {
        if (monthFilterSelect.value !== 'all' && (parseInt(d.split('/')[0]) - 1) !== parseInt(monthFilterSelect.value)) return;
        totalDaysWorked++;
        attendanceMap[d].sessions.forEach(s => {
          totalMins += (s.inTime && s.outTime) ? calcMin(s.inTime, s.outTime) : 0;
        });
      });
      updateStats(totalDaysWorked, totalMins);

      // Update local duration tag
      const row = event.target.closest('tr');
      const durTag = row.querySelector('.tag-duration');
      const m = (session.inTime && session.outTime) ? calcMin(session.inTime, session.outTime) : 0;
      durTag.textContent = m > 0 ? `${Math.floor(m / 60)}h ${m % 60}m` : '-';
    }

    function updateStats(days, mins) {
      const reqDays = +totalDaysInput.value || 0;
      const reqHrs = +dailyHoursInput.value || 0;
      const requiredTotal = reqDays * reqHrs;
      const workedTotal = mins / 60;
      const overtime = Math.max(0, workedTotal - requiredTotal);

      document.getElementById("statRequired").textContent = `${requiredTotal}h`;
      document.getElementById("statWorked").textContent = `${workedTotal.toFixed(1)}h`;
      document.getElementById("statAvg").textContent = days > 0 ? `${(workedTotal / days).toFixed(1)}h` : '0h';
      document.getElementById("statOvertime").textContent = `${overtime.toFixed(1)}h`;
    }

    function calcMin(t1, t2) {
      const parse = (t) => {
        t = t.replace(/\s/g, ' ').replace(/[^\x00-\x7F]/g, ""); // Clean unicode
        const m = t.match(/(\d+):(\d+)(?::(\d+))?\s*([AP]M)/i);
        if (!m) return null;
        let h = parseInt(m[1]);
        const min = parseInt(m[2]);
        const ampm = m[4].toUpperCase();
        if (ampm === "PM" && h < 12) h += 12;
        if (ampm === "AM" && h === 12) h = 0;
        return h * 60 + min;
      };
      const m1 = parse(t1), m2 = parse(t2);
      if (m1 === null || m2 === null) return 0;
      return m2 >= m1 ? m2 - m1 : (1440 - m1) + m2;
    }

    function parseDate(s) {
      const [m, d, y] = s.split('/').map(Number);
      return new Date(2000 + y, m - 1, d);
    }

    exportBtn.addEventListener("click", () => {
      const wb = XLSX.utils.book_new();
      const headers = ["Date", "Entry Time", "Exit Time", "Duration (Hrs)", "Context Message"];
      const rows = [headers];

      Object.keys(attendanceMap).sort((a, b) => parseDate(a) - parseDate(b)).forEach(d => {
        if (monthFilterSelect.value !== 'all' && (parseInt(d.split('/')[0]) - 1) !== parseInt(monthFilterSelect.value)) return;
        attendanceMap[d].sessions.forEach(s => {
          const m = (s.inTime && s.outTime) ? calcMin(s.inTime, s.outTime) : 0;
          rows.push([d, s.inTime, s.outTime, (m / 60).toFixed(2), s.inMsg]);
        });
      });

      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, "Attendance Report");
      XLSX.writeFile(wb, `Attendance_Report_${nameFilterInput.value || 'User'}.xlsx`);
    });
  </script>
</body>

</html>